<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <link rel="stylesheet" href="product-style.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>edit</title>
</head>
<body>
    
    <button class="save" id="save-button">save</button>
    <button class="delete" id="delete-button">delete</button>
    </div>
    <label id="name-label" for="name-input"> 
        שם:
        <input type="text " id="name-input" value="${start_data.name}" placeholder="enter product name">
    </label>
    <label id="price-label" for="price-input">
        מחיר:
        <input type="text " id="price-input" value="${start_data.price}" placeholder="enter product price">
    </label>
    <label id="notes-label" for="notes-input">
        הערות ללקוח:
        <input type="text " id="secondNotes-input" value="${start_data.specialNotes}" placeholder="enter special notes">
    </label>
    <label id="secondNotes-label" for="secondNotes-input">
        הערות למוכר:
        <input type="text " id="notes-input" value="${start_data.secondSpecialNotes}" placeholder="enter second special notes">
    </label>
    <label id="type-label" for="type-input">
        סוג:
        <input type="text " id="type-input" value="${start_data.type}" placeholder="enter product type">
    </label>
    <label id="image-label" for="image-input">
        תמונה:
        <input type="file" id ="image-input" accept="image/*">
    </label>
    <img src="" alt="" id="image-preview">
    <script type="module" >
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
    import { getFirestore , collection, addDoc, getDocs , getDoc, doc, setDoc, deleteDoc} from "https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-storage.js";
      
        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyC_05cP9iqq6dZ1wB78_r7-XYFrTO7guhM",
          authDomain: "yokraproject-470b9.firebaseapp.com",
          projectId: "yokraproject-470b9",
          storageBucket: "yokraproject-470b9.appspot.com",
          messagingSenderId: "868266877329",
          appId: "1:868266877329:web:ab972b5684b001dc177a30",
          measurementId: "G-FW1ZGF06M6",
          storageBucket: "gs://yokraproject-470b9.appspot.com"
        };
      
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        //Initialize the variables
        let start_data ;
        let new_data;
        let isImgSelected = false;
        let isUploaded = true;
        let file;
   
        const nameInput = document.getElementById("name-input");
        const priceInput = document.getElementById("price-input");
        const notesInput = document.getElementById("notes-input");
        const secondNotesInput = document.getElementById("secondNotes-input");
        const typeInput = document.getElementById("type-input");
        const imageInput = document.getElementById("image-input");
        const imagePreview = document.getElementById("image-preview");
        const saveButton = document.getElementById("save-button");
        const deleteButton = document.getElementById("delete-button");

        //functions
        imageInput.addEventListener("change", function(){
            isImgSelected = true;
            imagePreview.src = URL.createObjectURL(imageInput.files[0]);
            file = imageInput.files[0];
        })

        saveButton.addEventListener("click", function(){
            new_data = {
                name: nameInput.value,
                price: priceInput.value,
                specialNotes: notesInput.value,
                secondSpecialNotes: secondNotesInput.value,
                type: typeInput.value,
                uri: start_data.uri
            }
            updateData();
        })
        
        deleteButton.addEventListener("click", function(){
            deleteData();
        })

        function updateData(){
            if(nameInput.value == ""){
                alert("enter product name");
                return;
            }
            if(isImgSelected){
                isUploaded = false;
                new_data.uri = file.name;
                uploadImage();
            }
            if(new_data.name != start_data.name && start_data.name != null){
                deleteData();
            }
            setDoc(doc(db, "products", new_data.name), new_data).then(() => {
                if(isUploaded){
                    window.location.href = "index.html";
                } else {
                    isUploaded = true;
                }
            }).catch((error) => {
                console.error("Error adding document: ", error);
            });

        }

        function uploadImage(){
            const storageRef = ref(storage, new_data.uri);

            // Create a unique name for the image file
            const imageName = new_data.uri;

            // Upload the file to Firebase Storage
            const uploadTask = uploadBytesResumable(storageRef, file);
            // Monitor the upload progress
            uploadTask.on("state_changed",
            (error) => {
                logger.error(error);
                alert("Error uploading image: " + error + "\n please report this error to the developer");
            }, 
            () => {
                // Upload completed successfully, now we can get the download URL
                if(isUploaded){
                    window.location.href = "index.html";
                }else{
                    isUploaded = true;
                }
            }
            );
            if(!start_data.uri == "icon.jpg"){
                deleteObject(ref(storage, start_data.uri));
            }
        }

        function setTheView() {
            nameInput.value = start_data.name;
            priceInput.value = start_data.price;
            notesInput.value = start_data.specialNotes;
            secondNotesInput.value = start_data.secondSpecialNotes;
            typeInput.value = start_data.type;
            if(start_data.uri != null){
                getDownloadURL(ref(storage, start_data.uri)).then((url) => {
                imagePreview.src = url;
                })
            }else{
                getDownloadURL(ref(storage, "icon.png")).then((url) => {
                    imagePreview.src = url;
                })
            }
        }
        
        function deleteData(){
            if(start_data.name == null){
                alert("no product to delete");
                return;
            }
            deleteDoc(doc(db, "products", start_data.name)).then(() => {
                window.location.href = "index.html";
            }).catch((error) => {
                console.error("Error removing document: ", error);
            });
        }

        //get the start_data
        if (localStorage.getItem('selected_product') != "null") {
            const docRef = doc(db, "products", localStorage.getItem('selected_product'));
            const docSnap = await getDoc(docRef);
            start_data = {
                name: docSnap.data().name,
                price: docSnap.data().price,
                specialNotes: docSnap.data().specialNotes,
                secondSpecialNotes: docSnap.data().secondSpecialNotes,
                type: docSnap.data().type,
                uri: docSnap.data().uri
            }
            setTheView();
        } else {
            start_data = {
                name: null,
                price: null,
                specialNotes: null,
                secondSpecialNotes: null,
                type: null,
                uri: "icon.jpg"
            }
            setTheView();
        }
        
        </script>
    
</body>
</html>